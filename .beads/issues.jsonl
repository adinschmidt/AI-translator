{"id":"bd-2m3","title":"Full-page translation v2 gaps","description":"Follow-up work to fully cover PLAN_v2 requirements on master. Each child task is self-contained with all needed context, because plan docs may be removed.","status":"closed","priority":2,"issue_type":"epic","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:22:38.187178-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T00:36:16.676227-05:00","closed_at":"2026-01-25T00:36:16.676227-05:00","close_reason":"All 8 child tasks completed (bd-2m3.1 through bd-2m3.8)"}
{"id":"bd-2m3.1","title":"Enforce HARD_MAX_UNIT_CHARS during splitting","description":"Context: `content.js` defines `MAX_UNIT_CHARS=800` and `HARD_MAX_UNIT_CHARS=2000`, but splitting functions only use MAX; long sentences/words can exceed the hard cap and still be sent to the API. Work: - Update `splitTextIntoChunks`, `splitByWords`, and `unitNeedsSplitting` to enforce `HARD_MAX_UNIT_CHARS` so no chunk exceeds 2000 chars. - When a sentence or word exceeds `HARD_MAX_UNIT_CHARS`, split by character slices (preserve order). - Ensure `collectSafeTranslationUnits` uses the updated splitter and keeps `chunkIndex`/`totalChunks` accurate. Acceptance: - No serialized unit/chunk exceeds `HARD_MAX_UNIT_CHARS`. - Oversized single words/sentences are split deterministically. - Chunk metadata remains correct and translation flow unchanged otherwise.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:22:54.469463-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:32:57.30549-05:00","closed_at":"2026-01-24T23:32:57.30549-05:00","close_reason":"Added splitByCharacters helper and updated splitByWords to enforce HARD_MAX_UNIT_CHARS (2000) by splitting oversized words by character slices","dependencies":[{"issue_id":"bd-2m3.1","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:22:54.471376-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.2","title":"Cache key includes provider/model/language/instructions + placeholders","description":"Context: `TranslationQueue.getCacheKey` currently returns only `serializedText` (plain text), so cache collisions occur across providers, models, languages, and formatting; placeholder tokens are not included in the key. Work: - Build a stable cache context at translation start (provider, model, endpoint, target language, translation instructions). - Include the placeholder-serialized input string (with ⟦P0⟧/⟦/P0⟧) in the key. - Update `TranslationQueue.getCacheKey` to incorporate the context + placeholder string (hashing is OK). Acceptance: - Cache keys differ across provider/model/endpoint/language/instructions. - Cache uses placeholder-serialized input, not just `.textContent`.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:22:57.653022-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:39:51.126112-05:00","closed_at":"2026-01-24T23:39:51.126112-05:00","close_reason":"Closed","dependencies":[{"issue_id":"bd-2m3.2","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:22:57.654378-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.3","title":"Use placeholder validation + truncation detection to trigger fallback","description":"Context: `validatePlaceholders` is checked but invalid output is still used after retries; `isOutputTruncated` exists but is never invoked. Work: - After each translation result, run `validatePlaceholders` and `isOutputTruncated`. - If invalid/truncated, retry once using the strict placeholder prompt. - If still invalid/truncated, treat the unit as failed and trigger fallback (text-only or HTML fallback) instead of applying the bad output. - Ensure queue stats reflect failures and `onUnitComplete` receives `success:false` for fallback paths. Acceptance: - Invalid or truncated outputs are never applied to the DOM. - Retry happens once with strict prompt, then fallback is used.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:23:00.914262-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:43:49.525121-05:00","closed_at":"2026-01-24T23:43:49.525121-05:00","close_reason":"Closed","dependencies":[{"issue_id":"bd-2m3.3","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:23:00.916948-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.4","title":"Include translation instructions in translateUnit prompt","description":"Context: `background.js` `translateUnitText` only uses a generic \"Translate to {language}\" prompt and ignores user/provider `translationInstructions`. Work: - Resolve `translationInstructions` similarly to `getSettingsAndTranslate`: - Basic mode: `buildBasicTranslationInstructions(languageLabel)` - Advanced mode: `perProvider.translationInstructions` or `DEFAULT_TRANSLATION_INSTRUCTIONS` - Prepend these instructions to the user prompt, along with the placeholder-preservation requirement. - Ensure the instructions are part of the cache key context (see cache-key task). Acceptance: - Unit translations respect custom instructions in Advanced mode and Basic mode defaults.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:23:03.647713-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:48:25.004948-05:00","closed_at":"2026-01-24T23:48:25.004948-05:00","close_reason":"Implemented: translateUnitText now resolves translationInstructions from settings (Basic mode: buildBasicTranslationInstructions; Advanced mode: perProvider.translationInstructions or DEFAULT_TRANSLATION_INSTRUCTIONS) and includes them in the user prompt along with placeholder-preservation requirement.","dependencies":[{"issue_id":"bd-2m3.4","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:23:03.649636-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.5","title":"Placeholder-aware applyTranslationToUnit mapping","description":"Context: `applyTranslationToUnit` parses placeholders but then concatenates all text and distributes by proportion, which can misassign text to inline elements. Work: - Use `parsePlaceholderOutput` to map translated segments between ⟦P#⟧ markers to the correct text nodes. - Walk the DOM and apply text to the exact nodes inside matching inline elements; keep DOM structure intact and avoid `innerHTML` writes. - If placeholder mapping fails, return false to trigger fallback. Acceptance: - Inline formatting boundaries are preserved; text does not drift across inline elements. - Placeholder tokens drive segmentation, not proportional heuristics.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:23:06.547164-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T00:08:25.816051-05:00","closed_at":"2026-01-25T00:08:25.816051-05:00","close_reason":"Implemented placeholder-aware applyTranslationToUnit mapping","dependencies":[{"issue_id":"bd-2m3.5","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:23:06.548854-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.6","title":"HTML fallback with DOMPurify + safe URI policy","description":"Context: Only text-only fallback exists; PLAN_v2 specifies an optional HTML fallback for inline-only safe elements with strict sanitization. Work: - Implement optional HTML fallback when placeholder mapping fails. - Only run on elements that are inline-only and have no interactive descendants. - Translate inline HTML (reuse `translateElement` or add a dedicated handler). - Sanitize with DOMPurify using an explicit allowlist and enforce safe URI protocols (http/https/mailto/relative; reject javascript:, data:, etc.). Acceptance: - HTML fallback only runs on safe inline-only elements. - Sanitized output contains only allowed tags/attrs and safe hrefs.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:23:09.406582-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T00:20:18.72808-05:00","closed_at":"2026-01-25T00:20:18.72808-05:00","close_reason":"Implemented HTML fallback with DOMPurify + safe URI policy. Added isSafeForHtmlFallback() to check for inline-only safe elements, HTML_FALLBACK_DOMPURIFY_CONFIG with explicit allowlist and safe URI protocol enforcement, and applyHtmlFallback() that sanitizes with DOMPurify and falls back to plain text. Updated queue.onUnitComplete to try HTML fallback before plain text fallback when placeholder mapping fails. purify.min.js already included in manifest.json.","dependencies":[{"issue_id":"bd-2m3.6","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:23:09.408432-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.7","title":"Error policy threshold + reduced per-unit logging","description":"Context: Per-unit errors are logged individually; there is no thresholded summary when error rates are high. Work: - Track error count and error rate in `translatePageV2` or the queue callbacks. - Log only the first N errors (e.g., 3), then suppress per-unit logs. - If error rate \u003e 20%, show a summary message in the UI and/or a single console warning. Acceptance: - Console spam is reduced; summary appears when error rate is high.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:23:12.224146-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T00:33:52.080915-05:00","closed_at":"2026-01-25T00:33:52.080915-05:00","close_reason":"Implemented error policy threshold: logs only first 3 errors, shows summary warning when error rate \u003e 20%","dependencies":[{"issue_id":"bd-2m3.7","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:23:12.226082-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.8","title":"Stop ignores late results","description":"Context: `TranslationQueue.stop()` prevents new work but in-flight translations still apply via `onUnitComplete`; PLAN_v2 expects late results to be ignored. Work: - When stop is triggered, ignore any late `onUnitComplete` results (check `queue.stopped` / `stopTranslationFlag` before applying). - Ensure no additional DOM updates occur after Stop is pressed. Acceptance: - After stop, no new elements are translated or updated, even if in-flight requests complete.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:23:14.419453-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:46:05.992327-05:00","closed_at":"2026-01-24T23:46:05.992327-05:00","close_reason":"Added stopTranslationFlag check at start of onUnitComplete callback to ignore late results after stop is triggered","dependencies":[{"issue_id":"bd-2m3.8","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:23:14.421608-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2xd","title":"Content: DOM-aware splitting for oversized units (block/text node chunking)","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T01:02:36.650664-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T01:34:26.045453-05:00","closed_at":"2026-01-25T01:34:26.045453-05:00","close_reason":"Closed","dependencies":[{"issue_id":"bd-2xd","depends_on_id":"bd-8rr","type":"blocks","created_at":"2026-01-25T01:02:49.199178-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-2xd","depends_on_id":"bd-bqj","type":"blocks","created_at":"2026-01-25T01:02:49.866396-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-4al","title":"Manual smoke checklist: links/formatting-heavy pages + regressions","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T01:02:38.23967-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T01:54:46.973401-05:00","closed_at":"2026-01-25T01:54:46.973401-05:00","close_reason":"Added manual smoke checklist items for links, formatting, regressions","dependencies":[{"issue_id":"bd-4al","depends_on_id":"bd-di4","type":"blocks","created_at":"2026-01-25T01:02:52.055534-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-4eo","title":"Option 2: Preserve Images/Non-Text Nodes via Region-Based Full-Page Translation","description":"## Background\nFull-page translation (V3) currently works in `src/extension/content.ts` via:\n\n`translatePageV3()` -\u003e `collectHTMLTranslationUnits()` -\u003e `extractUnitHTML()` (allowlist serialization) -\u003e send HTML to background -\u003e results -\u003e `applyTranslatedHTML()`.\n\n## Problem Statement\n`extractUnitHTML()` / `getNodeSimplifiedHTML()` strip non-allowlisted tags such as `img`. Then `applyTranslatedHTML()` clears **all** children of the unit element and inserts the translated fragment. This deletes DOM content that was intentionally excluded from translation (images, icons, widgets, etc.).\n\nExample (typical Wikipedia infobox cell):\n`\u003cspan typeof=\"mw:File\"\u003e\u003ca href=\"...\"\u003e\u003cimg ...\u003e\u003c/a\u003e\u003c/span\u003e\u003cbr\u003e\u003ca ...\u003e...\u003c/a\u003e...`\n\nCurrent behavior can drop the `\u003cimg\u003e` after translation.\n\n## Goal / Scope\nImplement Option 2: translate only **text-bearing regions** inside a “safe” unit element while leaving non-text / complex nodes untouched. Preserve existing sanitization (DOMPurify) and keep the allowlist unchanged (do **not** add `img`).\n\n## Non-Goals\n- Do not add `img` (or other complex tags) to the simplified HTML allowlist.\n- Do not rewrite provider/background translation logic.\n- Do not modify `dist/` or vendored `*.min.js`.\n- Do not translate extension UI/overlays/options UI.\n\n## High-Level Approach (Option 2)\n- For each selected unit element, scan its **direct** `childNodes`.\n- Identify contiguous “translatable regions”: sequences of text nodes and inline elements with meaningful text.\n- Exclude/skip/keep untouched non-text or complex nodes (e.g., image-only spans/anchors, icons).\n- Translate only the region’s simplified HTML.\n- Apply results by surgically replacing only the nodes belonging to each region (Range-based or equivalent), leaving preserved siblings (like image wrappers) in place.\n- Support multiple regions per element.\n\n## Risks / Edge Cases\n- Region boundary correctness around `\u003cbr\u003e` / `\u003cwbr\u003e` / block-ish nodes embedded inline.\n- Inline elements containing both text and images (mixed content).\n- Node targeting robustness when DOM changes between collection and apply.\n- Chunking and ordering: large regions must split/reassemble safely without corrupting DOM structure.\n- Partial failures: a failed region translation must not wipe preserved nodes.\n\n## Child Tickets Checklist\n- [ ] A. Design spec: translatable regions + targeting strategy\n- [ ] B. Implement region discovery and unit generation\n- [ ] C. Implement surgical DOM apply for a region\n- [ ] D. Integrate region-based units into translatePageV3 pipeline (incl. chunking + progress)\n- [ ] E. Manual regression checklist (Wikipedia / links / formatting)\n\n## Acceptance Criteria\n- Full-page translation preserves images and other non-text nodes inside translated containers (verify on a Wikipedia infobox with an image).\n- Anchor tags and `href` attributes remain intact after full-page translation.\n- Extension UI (indicator/overlays/options UI) is not translated.\n- Implementation translates only text regions within unit elements; preserved nodes remain in DOM.\n- Existing sanitization (DOMPurify) remains in use; do not add `img` to the allowlist.\n- No edits to `dist/` or `*.min.js`.\n","acceptance_criteria":"Images and other non-text DOM nodes (e.g., \u003cimg\u003e) are preserved during full-page translation on pages like Wikipedia; anchor tags and hrefs are preserved; extension UI is not translated; solution uses region-based translation within unit elements without adding img to allowlist; no changes to dist/ or *.min.js.","status":"open","priority":2,"issue_type":"epic","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-26T03:11:06.318357-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-26T03:11:06.318357-05:00"}
{"id":"bd-4eo.1","title":"Design spec: translatable regions + targeting strategy","description":"## Context\nFile: `src/extension/content.ts`\n\nCurrent V3 full-page translation flow:\n`translatePageV3()` -\u003e `collectHTMLTranslationUnits()` -\u003e `extractUnitHTML()` / `getNodeSimplifiedHTML()` (allowlist serialization) -\u003e background translation -\u003e `applyTranslatedHTML()`.\n\nRoot cause: allowlist strips non-text tags (e.g., `img`), then `applyTranslatedHTML()` replaces **all** children, deleting excluded nodes.\n\nChosen approach (Option 2): Within each selected “safe” unit element, translate only text-bearing regions and surgically replace only those nodes, leaving images/icons/etc untouched. Keep DOMPurify; do NOT add `img` to allowlist.\n\n## Task\nWrite a design spec for “translatable regions” discovery and robust region targeting/replacement.\n\n## Design Spec (to fill in)\n### 1) Region Boundary Rules\nDefine how to walk `unitEl.childNodes` and split into regions.\n\nSpecify:\n- What counts as “meaningful text” in a Text node (e.g., trimming whitespace, handling punctuation-only nodes, NBSP, zero-width spaces).\n- Which element nodes are eligible to be part of a region (inline-ish elements like `A`, `SPAN`, `B`, `I`, etc.) and which are boundaries.\n- Explicit boundaries:\n  - Treat `\u003cbr\u003e` as a hard boundary (end current region, preserved).\n  - Decide on `\u003cwbr\u003e` (usually boundary).\n  - Decide on comment nodes, empty text nodes, whitespace-only nodes.\n- How to treat inline elements that contain:\n  - Only images/icons (e.g., `A` wrapping `IMG`) -\u003e preserved, not included in regions.\n  - Mixed text + image -\u003e decide: either include element in region but simplified HTML excludes image OR treat as boundary and preserve to avoid losing image.\n- How to handle nested inline elements: region should include them as HTML using existing simplified serialization rules.\n\n### 2) Region HTML Serialization\nDefine how the region’s HTML is generated:\n- Must reuse existing simplified HTML rules (`getNodeSimplifiedHTML` / allowlist) and explicitly exclude `IMG`.\n- Decide whether serialization starts from original child nodes or via a temporary wrapper element.\n\n### 3) Targeting Strategy for Apply\nDefine how to identify “the nodes to replace” later:\n- Options to evaluate:\n  - Store Node references (risk: stale if DOM mutates).\n  - Store child index ranges (risk: indices shift if DOM mutates).\n  - Insert temporary marker nodes (start/end comments) during collection and remove after apply.\n  - Store a stable selector + offsets (likely too complex).\n- Pick one strategy and specify:\n  - Data structure stored in the unit metadata.\n  - How to compute the Range (or equivalent) at apply time.\n  - How to handle missing/changed nodes (skip region and log error; must not wipe preserved nodes).\n\n### 4) Chunking\nDefine chunking behavior per region:\n- How region HTML units should be split to respect `MAX_HTML_UNIT_CHARS`.\n- Whether to reuse existing splitting helpers.\n- How to reassemble multiple chunks back into one translated fragment for apply.\n- Ordering guarantees when multiple regions exist in one element.\n\n### 5) Progress + Error Accounting\nDefine how region-based units affect:\n- Progress indicator accuracy.\n- Partial failures: region fails -\u003e do not modify DOM for that region; continue others.\n\n### 6) Examples\nInclude at least:\n- Wikipedia infobox cell example with `\u003cspan typeof=\"mw:File\"\u003e...\u003cimg\u003e...\u003c/span\u003e\u003cbr\u003e...text...` showing which nodes become regions vs preserved.\n\n## Acceptance Criteria\n- Issue description contains a complete, implementable spec for:\n  - Region boundary rules (incl. `\u003cbr\u003e` / `\u003cwbr\u003e` / whitespace and image-only nodes).\n  - A robust targeting strategy for region replacement.\n  - Chunking/reassembly per region respecting `MAX_HTML_UNIT_CHARS`.\n  - Progress/error handling guidance.\n- A future agent can implement B/C/D using only this spec (no additional clarification required).\n","design":"## Design Spec (Complete)\n\n### 1) Region Boundary Rules\n\n**Definitions:**\n\nA **region** is a contiguous sequence of child nodes within a unit element that contain translatable text content.\n\n**Node Classification Algorithm:**\n\nWalk `unitEl.childNodes` directly (first-level children only). Classify each node:\n\n1. **BOUNDARY nodes** (end current region, preserved in place):\n   - `\u003cbr\u003e` elements\n   - `\u003cwbr\u003e` elements  \n   - Elements where `getNodeSimplifiedHTML(node)` returns empty string (e.g., image-only wrappers like `\u003cspan\u003e\u003cimg\u003e\u003c/span\u003e` or `\u003ca\u003e\u003cimg\u003e\u003c/a\u003e`)\n\n2. **TRANSLATABLE nodes** (become part of a region):\n   - Text nodes (all, including whitespace-only—normalization happens during serialization)\n   - Elements where `getNodeSimplifiedHTML(node)` returns non-empty string\n\n3. **SKIP nodes** (ignored entirely):\n   - Comment nodes\n\n**Meaningful Text Detection:**\n\nA region is only valid if its serialized HTML has meaningful text:\n\\`\\`\\`typescript\nfunction hasNonWhitespaceText(html: string): boolean {\n  const textOnly = html.replace(/\u003c[^\u003e]*\u003e/g, \"\");\n  return textOnly.trim().length \u003e 0;\n}\n\\`\\`\\`\n\n**Region Formation Algorithm:**\n\\`\\`\\`typescript\ninterface Region {\n  startIndex: number;  // childNodes index of first node\n  endIndex: number;    // childNodes index of last node (inclusive)\n  nodes: Node[];       // actual Node references for serialization\n}\n\nfunction identifyRegions(unitEl: Element): Region[] {\n  const regions: Region[] = [];\n  let currentRegion: { startIndex: number; nodes: Node[] } | null = null;\n  const children = Array.from(unitEl.childNodes);\n\n  for (let i = 0; i \u003c children.length; i++) {\n    const child = children[i];\n    const classification = classifyNode(child);\n\n    if (classification === 'TRANSLATABLE') {\n      if (!currentRegion) {\n        currentRegion = { startIndex: i, nodes: [] };\n      }\n      currentRegion.nodes.push(child);\n    } else if (classification === 'BOUNDARY') {\n      // Finalize current region if it has meaningful text\n      if (currentRegion \u0026\u0026 currentRegion.nodes.length \u003e 0) {\n        const html = serializeRegionNodes(currentRegion.nodes);\n        if (hasNonWhitespaceText(html)) {\n          regions.push({\n            startIndex: currentRegion.startIndex,\n            endIndex: i - 1,\n            nodes: currentRegion.nodes,\n          });\n        }\n      }\n      currentRegion = null;\n      // BOUNDARY node is preserved (not part of any region)\n    }\n    // SKIP nodes are ignored (don't affect region boundaries)\n  }\n\n  // Finalize last region\n  if (currentRegion \u0026\u0026 currentRegion.nodes.length \u003e 0) {\n    const html = serializeRegionNodes(currentRegion.nodes);\n    if (hasNonWhitespaceText(html)) {\n      regions.push({\n        startIndex: currentRegion.startIndex,\n        endIndex: children.length - 1,\n        nodes: currentRegion.nodes,\n      });\n    }\n  }\n\n  return regions;\n}\n\nfunction classifyNode(node: Node): 'TRANSLATABLE' | 'BOUNDARY' | 'SKIP' {\n  if (node.nodeType === Node.COMMENT_NODE) {\n    return 'SKIP';\n  }\n  if (node.nodeType === Node.TEXT_NODE) {\n    return 'TRANSLATABLE';\n  }\n  if (node.nodeType === Node.ELEMENT_NODE) {\n    const el = node as Element;\n    const tag = el.tagName.toUpperCase();\n    if (tag === 'BR' || tag === 'WBR') {\n      return 'BOUNDARY';\n    }\n    const simplifiedHTML = getNodeSimplifiedHTML(node);\n    if (simplifiedHTML.trim().length === 0) {\n      return 'BOUNDARY';  // No text content (image-only, icon-only, etc.)\n    }\n    return 'TRANSLATABLE';\n  }\n  return 'SKIP';  // Other node types (processing instructions, etc.)\n}\n\\`\\`\\`\n\n**Edge Cases:**\n- Empty element (no children): No regions created.\n- All children are boundaries: No regions created.\n- Single text node: One region containing that node.\n- Nested inline elements with mixed content (text + image): The outer element is classified as TRANSLATABLE if it has ANY text. The nested image is excluded by \\`getNodeSimplifiedHTML\\` (not in allowlist), but the text is preserved. This is safe because we're replacing region nodes, not the element's entire contents.\n\n---\n\n### 2) Region HTML Serialization\n\n**Serialization Function:**\n\\`\\`\\`typescript\nfunction serializeRegionNodes(nodes: Node[]): string {\n  let html = \"\";\n  for (const node of nodes) {\n    html += getNodeSimplifiedHTML(node);\n  }\n  return html.replace(/\\s+/g, \" \").trim();\n}\n\\`\\`\\`\n\nThis reuses existing allowlist (\\`HTML_UNIT_ALLOWED_TAGS\\`) and attribute rules. Images, icons, and other non-allowlisted elements are automatically excluded from the serialized HTML.\n\n**No wrapper element needed**: We serialize individual nodes and concatenate. The translated HTML will be parsed into a fragment and used to replace the region nodes directly.\n\n---\n\n### 3) Targeting Strategy for Apply\n\n**Chosen Strategy: Marker Comments**\n\nInsert temporary HTML comment markers before and after each region during collection. Use a unique ID (UUID) to identify each region.\n\n**Marker Format:**\n- Start marker: \\`\u003c!--TR_REGION_START_{uuid}--\u003e\\`\n- End marker: \\`\u003c!--TR_REGION_END_{uuid}--\u003e\\`\n\n**Collection Phase:**\n\n\\`\\`\\`typescript\ninterface RegionUnit {\n  parentElement: Element;\n  regionId: string;           // UUID v4\n  html: string;               // Serialized region HTML\n  chunkIndex?: number;\n  totalChunks?: number;\n}\n\nfunction insertRegionMarkers(unitEl: Element, region: Region): string {\n  const regionId = crypto.randomUUID();\n  const startMarker = document.createComment(\\`TR_REGION_START_\\${regionId}\\`);\n  const endMarker = document.createComment(\\`TR_REGION_END_\\${regionId}\\`);\n\n  // Insert start marker before first region node\n  const firstNode = region.nodes[0];\n  unitEl.insertBefore(startMarker, firstNode);\n\n  // Insert end marker after last region node\n  const lastNode = region.nodes[region.nodes.length - 1];\n  if (lastNode.nextSibling) {\n    unitEl.insertBefore(endMarker, lastNode.nextSibling);\n  } else {\n    unitEl.appendChild(endMarker);\n  }\n\n  return regionId;\n}\n\\`\\`\\`\n\n**Data Structure for Unit Metadata:**\n\\`\\`\\`typescript\ninterface RegionTranslationUnit {\n  parentElement: Element;  // The unit element containing this region\n  regionId: string;        // UUID for marker identification\n  html: string;            // Serialized simplified HTML\n  chunkIndex?: number;     // For chunked regions\n  totalChunks?: number;    // For chunked regions\n}\n\\`\\`\\`\n\n**Apply Phase:**\n\n\\`\\`\\`typescript\nfunction applyRegionTranslation(\n  parentElement: Element,\n  regionId: string,\n  translatedHtml: string\n): boolean {\n  // 1. Find markers\n  const startMarker = findMarkerComment(parentElement, \\`TR_REGION_START_\\${regionId}\\`);\n  const endMarker = findMarkerComment(parentElement, \\`TR_REGION_END_\\${regionId}\\`);\n\n  if (!startMarker || !endMarker) {\n    console.warn(\\`applyRegionTranslation: markers not found for region \\${regionId}\\`);\n    return false;  // Skip this region, don't modify DOM\n  }\n\n  // 2. Sanitize translated HTML\n  const sanitized = sanitizeTranslatedHTML(translatedHtml);\n  if (!sanitized || sanitized.trim().length === 0) {\n    console.warn(\\`applyRegionTranslation: empty sanitized result for region \\${regionId}\\`);\n    // Decision: skip entirely to preserve original content\n    return false;\n  }\n\n  // 3. Parse translated HTML into fragment\n  const temp = document.createElement(\"template\");\n  temp.innerHTML = sanitized;\n  const fragment = temp.content;\n\n  // 4. Remove nodes between markers (exclusive)\n  let current = startMarker.nextSibling;\n  while (current \u0026\u0026 current !== endMarker) {\n    const next = current.nextSibling;\n    parentElement.removeChild(current);\n    current = next;\n  }\n\n  // 5. Insert translated content before end marker\n  parentElement.insertBefore(fragment.cloneNode(true), endMarker);\n\n  // 6. Remove markers\n  parentElement.removeChild(startMarker);\n  parentElement.removeChild(endMarker);\n\n  return true;\n}\n\nfunction findMarkerComment(parent: Element, markerText: string): Comment | null {\n  for (const child of Array.from(parent.childNodes)) {\n    if (child.nodeType === Node.COMMENT_NODE \u0026\u0026 child.textContent === markerText) {\n      return child as Comment;\n    }\n  }\n  return null;\n}\n\\`\\`\\`\n\n**Error Handling at Apply Time:**\n- **Markers not found**: Log warning, skip region. Original content preserved.\n- **Empty translation result**: Skip region, do NOT remove original content.\n- **DOM mutation between collect and apply**: Markers may still be found; nodes between them are replaced regardless of what they now contain.\n- **Partial element modification**: If only some regions of an element fail, others can still be applied—each region is independent.\n\n---\n\n### 4) Chunking\n\n**When to Chunk:**\n\nA region needs chunking if \\`serializeRegionNodes(region.nodes).length \u003e MAX_HTML_UNIT_CHARS\\`.\n\n**Chunking Strategy:**\n\nReuse the existing \\`splitHTMLUnitByChildNodes\\` logic adapted for region nodes:\n\n\\`\\`\\`typescript\ninterface RegionChunk {\n  html: string;\n  nodeIndices: number[];  // Indices within the region's nodes array\n}\n\nfunction splitRegionByNodes(region: Region, maxChars: number = MAX_HTML_UNIT_CHARS): RegionChunk[] {\n  const nodes = region.nodes;\n  const chunks: RegionChunk[] = [];\n  let currentChunk: { parts: string[]; nodeIndices: number[]; length: number } = {\n    parts: [],\n    nodeIndices: [],\n    length: 0,\n  };\n\n  for (let i = 0; i \u003c nodes.length; i++) {\n    const node = nodes[i];\n    const nodeHTML = getNodeSimplifiedHTML(node);\n    const nodeLength = nodeHTML.length;\n\n    if (nodeLength === 0) continue;\n\n    if (nodeLength \u003e maxChars) {\n      if (currentChunk.parts.length \u003e 0) {\n        chunks.push({ html: currentChunk.parts.join(\"\"), nodeIndices: currentChunk.nodeIndices });\n        currentChunk = { parts: [], nodeIndices: [], length: 0 };\n      }\n\n      if (node.nodeType === Node.TEXT_NODE) {\n        const textChunks = splitTextNodeContent(node.textContent || \"\", maxChars);\n        for (const textChunk of textChunks) {\n          chunks.push({ html: textChunk, nodeIndices: [i] });\n        }\n      } else {\n        const subChunks = splitHTMLUnitByChildNodes(node as Element, maxChars);\n        for (const subChunk of subChunks) {\n          chunks.push({ html: subChunk.html, nodeIndices: [i] });\n        }\n      }\n      continue;\n    }\n\n    if (currentChunk.length + nodeLength \u003e maxChars \u0026\u0026 currentChunk.parts.length \u003e 0) {\n      chunks.push({ html: currentChunk.parts.join(\"\"), nodeIndices: currentChunk.nodeIndices });\n      currentChunk = { parts: [], nodeIndices: [], length: 0 };\n    }\n\n    currentChunk.parts.push(nodeHTML);\n    currentChunk.nodeIndices.push(i);\n    currentChunk.length += nodeLength;\n  }\n\n  if (currentChunk.parts.length \u003e 0) {\n    chunks.push({ html: currentChunk.parts.join(\"\"), nodeIndices: currentChunk.nodeIndices });\n  }\n\n  return chunks.map(c =\u003e ({ html: c.html.replace(/\\s+/g, \" \").trim(), nodeIndices: c.nodeIndices }));\n}\n\\`\\`\\`\n\n**Reassembly:**\n\nAll chunks for a region share the same \\`regionId\\`. At apply time:\n1. Wait for all chunks to be translated\n2. Concatenate translated HTML in chunk order: \\`chunk0 + \" \" + chunk1 + ...\\`\n3. Apply combined HTML using the region markers\n\n**Unit Generation with Chunking:**\n\n\\`\\`\\`typescript\nfunction collectRegionUnits(): RegionTranslationUnit[] {\n  const units: RegionTranslationUnit[] = [];\n\n  for (const unitEl of collectSafeUnitElements()) {\n    const regions = identifyRegions(unitEl);\n\n    for (const region of regions) {\n      const regionId = insertRegionMarkers(unitEl, region);\n      const html = serializeRegionNodes(region.nodes);\n\n      if (html.length \u003e MAX_HTML_UNIT_CHARS) {\n        const chunks = splitRegionByNodes(region, MAX_HTML_UNIT_CHARS);\n        for (let i = 0; i \u003c chunks.length; i++) {\n          if (chunks[i].html.length \u003e 0) {\n            units.push({\n              parentElement: unitEl,\n              regionId: regionId,\n              html: chunks[i].html,\n              chunkIndex: i,\n              totalChunks: chunks.length,\n            });\n          }\n        }\n      } else {\n        units.push({\n          parentElement: unitEl,\n          regionId: regionId,\n          html: html,\n        });\n      }\n    }\n  }\n\n  return units;\n}\n\\`\\`\\`\n\n**Ordering Guarantees:**\n- Multiple regions in one element have different \\`regionId\\`s and are independent.\n- Chunks within a region are ordered by \\`chunkIndex\\` (0, 1, 2...).\n- Each region's chunks must be reassembled before applying.\n\n---\n\n### 5) Progress + Error Accounting\n\n**Progress Indicator:**\n- \\`total\\` = total number of region chunks across all unit elements\n- \\`current\\` = number of chunks that received a translation response\n- Same display logic as current V3\n\n**Error Handling Per Region:**\n\n\\`\\`\\`typescript\ninterface RegionState {\n  regionId: string;\n  parentElement: Element;\n  chunks: Map\u003cnumber, { translatedHtml: string; error?: string }\u003e;\n  totalChunks: number;\n  applied: boolean;\n  hasError: boolean;\n}\n\nfunction applyRegionIfReady(state: RegionState): void {\n  if (state.applied || state.hasError) return;\n  if (state.chunks.size \u003c state.totalChunks) return;\n\n  for (const [, chunk] of state.chunks) {\n    if (chunk.error) {\n      state.hasError = true;\n      console.warn(\\`Region \\${state.regionId} has chunk error: \\${chunk.error}\\`);\n      return;\n    }\n  }\n\n  const orderedChunks = Array.from(state.chunks.entries())\n    .sort((a, b) =\u003e a[0] - b[0])\n    .map(([, c]) =\u003e c.translatedHtml);\n  const combinedHtml = orderedChunks.join(\" \");\n\n  const success = applyRegionTranslation(state.parentElement, state.regionId, combinedHtml);\n  if (success) {\n    state.applied = true;\n  } else {\n    state.hasError = true;\n  }\n}\n\\`\\`\\`\n\n**Partial Failure Behavior:**\n- If region A fails but region B succeeds, region B is still applied.\n- Failed regions keep their original content (between markers).\n- Markers for failed regions should be cleaned up at end of translation:\n\n\\`\\`\\`typescript\nfunction cleanupOrphanedMarkers(unitEl: Element): void {\n  const markers: Comment[] = [];\n  for (const child of Array.from(unitEl.childNodes)) {\n    if (child.nodeType === Node.COMMENT_NODE) {\n      const text = child.textContent || \"\";\n      if (text.startsWith(\"TR_REGION_START_\") || text.startsWith(\"TR_REGION_END_\")) {\n        markers.push(child as Comment);\n      }\n    }\n  }\n  for (const marker of markers) {\n    unitEl.removeChild(marker);\n  }\n}\n\\`\\`\\`\n\n---\n\n### 6) Examples\n\n**Example 1: Wikipedia Infobox Cell**\n\nOriginal DOM:\n\\`\\`\\`html\n\u003ctd\u003e\n  \u003cspan typeof=\"mw:File\"\u003e\u003ca href=\"/wiki/File:Example.jpg\"\u003e\u003cimg src=\"example.jpg\" width=\"100\"\u003e\u003c/a\u003e\u003c/span\u003e\n  \u003cbr\u003e\n  \u003ca href=\"/wiki/Person\"\u003eJohn Doe\u003c/a\u003e, an important person\n\u003c/td\u003e\n\\`\\`\\`\n\n**Step 1: Node Classification**\n\n| Index | Node | Classification | Reason |\n|-------|------|----------------|--------|\n| 0 | \\`\u003cspan typeof=\"mw:File\"\u003e...\\` | BOUNDARY | \\`getNodeSimplifiedHTML\\` → \\`\"\"\\` (img not in allowlist, no text) |\n| 1 | \\`\u003cbr\u003e\\` | BOUNDARY | BR is always a boundary |\n| 2 | \\`\u003ca href=\"...\"\u003eJohn Doe\u003c/a\u003e\\` | TRANSLATABLE | \\`getNodeSimplifiedHTML\\` → \\`\u003ca href=\"...\"\u003eJohn Doe\u003c/a\u003e\\` |\n| 3 | \\`, an important person\\` (text) | TRANSLATABLE | Text node with content |\n\n**Step 2: Region Identification**\n\n- Region 1: Nodes [2, 3], indices 2-3\n  - Serialized HTML: \\`\u003ca href=\"/wiki/Person\"\u003eJohn Doe\u003c/a\u003e, an important person\\`\n\n**Step 3: After Marker Insertion**\n\n\\`\\`\\`html\n\u003ctd\u003e\n  \u003cspan typeof=\"mw:File\"\u003e\u003ca href=\"/wiki/File:Example.jpg\"\u003e\u003cimg src=\"example.jpg\" width=\"100\"\u003e\u003c/a\u003e\u003c/span\u003e\n  \u003cbr\u003e\n  \u003c!--TR_REGION_START_abc-123--\u003e\n  \u003ca href=\"/wiki/Person\"\u003eJohn Doe\u003c/a\u003e, an important person\n  \u003c!--TR_REGION_END_abc-123--\u003e\n\u003c/td\u003e\n\\`\\`\\`\n\n**Step 4: After Translation Applied**\n\n\\`\\`\\`html\n\u003ctd\u003e\n  \u003cspan typeof=\"mw:File\"\u003e\u003ca href=\"/wiki/File:Example.jpg\"\u003e\u003cimg src=\"example.jpg\" width=\"100\"\u003e\u003c/a\u003e\u003c/span\u003e\n  \u003cbr\u003e\n  \u003ca href=\"/wiki/Person\"\u003e约翰·多伊\u003c/a\u003e，一位重要人物\n\u003c/td\u003e\n\\`\\`\\`\n\n✓ Image preserved  \n✓ Link href preserved  \n✓ BR preserved  \n✓ Only text translated\n\n---\n\n**Example 2: Mixed Content with Icon**\n\nOriginal DOM:\n\\`\\`\\`html\n\u003cp\u003e\n  \u003cspan class=\"icon\"\u003e★\u003c/span\u003e\n  Featured article about\n  \u003ca href=\"/topic\"\u003eimportant topic\u003c/a\u003e\n  \u003cspan class=\"share-icon\"\u003e\u003csvg\u003e...\u003c/svg\u003e\u003c/span\u003e\n\u003c/p\u003e\n\\`\\`\\`\n\n**Node Classification:**\n\n| Index | Node | Classification | Reason |\n|-------|------|----------------|--------|\n| 0 | \\`\u003cspan class=\"icon\"\u003e★\u003c/span\u003e\\` | TRANSLATABLE | Text content \"★\" |\n| 1 | \\`Featured article about \\` (text) | TRANSLATABLE | |\n| 2 | \\`\u003ca href=\"/topic\"\u003e...\u003c/a\u003e\\` | TRANSLATABLE | |\n| 3 | \\`\u003cspan class=\"share-icon\"\u003e...\\` | BOUNDARY | \\`getNodeSimplifiedHTML\\` → \\`\"\"\\` (svg stripped, no text) |\n\n**Regions:**\n- Region 1: Nodes [0, 1, 2], indices 0-2\n  - HTML: \\`\u003cspan\u003e★\u003c/span\u003e Featured article about \u003ca href=\"/topic\"\u003eimportant topic\u003c/a\u003e\\`\n\n**After Translation:**\n\\`\\`\\`html\n\u003cp\u003e\n  \u003cspan\u003e★\u003c/span\u003e 关于\u003ca href=\"/topic\"\u003e重要主题\u003c/a\u003e的特色文章\n  \u003cspan class=\"share-icon\"\u003e\u003csvg\u003e...\u003c/svg\u003e\u003c/span\u003e\n\u003c/p\u003e\n\\`\\`\\`\n\n✓ SVG icon preserved  \n✓ Star symbol included in translation (it's text)\n\n---\n\n**Example 3: Multiple Regions**\n\nOriginal DOM:\n\\`\\`\\`html\n\u003cdiv\u003e\n  Some text here\n  \u003cspan class=\"img-wrapper\"\u003e\u003cimg src=\"photo.jpg\"\u003e\u003c/span\u003e\n  More text after image\n  \u003cbr\u003e\n  Final paragraph text\n\u003c/div\u003e\n\\`\\`\\`\n\n**Node Classification:**\n\n| Index | Node | Classification |\n|-------|------|----------------|\n| 0 | \\`Some text here\\` | TRANSLATABLE |\n| 1 | \\`\u003cspan class=\"img-wrapper\"\u003e...\\` | BOUNDARY |\n| 2 | \\`More text after image\\` | TRANSLATABLE |\n| 3 | \\`\u003cbr\u003e\\` | BOUNDARY |\n| 4 | \\`Final paragraph text\\` | TRANSLATABLE |\n\n**Regions:**\n- Region 1: Node [0] → \"Some text here\"\n- Region 2: Node [2] → \"More text after image\"\n- Region 3: Node [4] → \"Final paragraph text\"\n\nEach region gets its own markers and is translated independently. If Region 2 fails, Regions 1 and 3 are still applied, and the image remains preserved.\n\n---\n\n## Summary\n\n| Component | Decision |\n|-----------|----------|\n| Meaningful text | Non-empty after \\`html.replace(/\u003c[^\u003e]*\u003e/g, \"\").trim()\\` |\n| Text nodes | All included (whitespace normalized during serialization) |\n| Inline elements | TRANSLATABLE if non-empty simplified HTML |\n| BR/WBR | Hard boundaries (preserved) |\n| Image-only elements | Boundaries (preserved) |\n| Targeting | Marker comments with UUID |\n| Chunking | By node, reusing \\`splitHTMLUnitByChildNodes\\` logic |\n| Reassembly | Concatenate chunks in order, apply via markers |\n| Partial failure | Per-region; other regions unaffected |\n| Marker cleanup | At end of translation for any orphaned markers |","acceptance_criteria":"Issue description contains a complete, implementable spec for region boundary rules, node targeting/replacement strategy, and chunking behavior (incl. MAX_HTML_UNIT_CHARS), requiring no additional clarification.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-26T03:11:28.260095-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-26T03:26:50.462808-05:00","closed_at":"2026-01-26T03:26:50.462808-05:00","close_reason":"Closed","dependencies":[{"issue_id":"bd-4eo.1","depends_on_id":"bd-4eo","type":"parent-child","created_at":"2026-01-26T03:11:28.262456-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-4eo.2","title":"Implement region discovery and unit generation","description":"## Context\nFile: `src/extension/content.ts`\n\nCurrent flow: `translatePageV3()` -\u003e `collectHTMLTranslationUnits()` -\u003e `extractUnitHTML()` / `getNodeSimplifiedHTML()` -\u003e background -\u003e results -\u003e `applyTranslatedHTML()`.\n\nRoot cause: simplified HTML strips `img`, and apply replaces all children, deleting images.\n\nOption 2: derive “translatable regions” from a unit element’s direct `childNodes` and translate only those regions.\n\n## Task\nImplement region discovery and unit generation in `src/extension/content.ts`:\n- For each selected “safe” unit element, scan its direct `childNodes` and group contiguous nodes into “translatable regions” per the design in ticket A.\n- For each region, produce a translation unit payload (HTML string) using existing simplified serialization rules (allowlisted tags/attrs only).\n- Region HTML must explicitly exclude non-allowlisted tags (do not add `img` to allowlist).\n- Generate enough metadata so later code can apply translation to that exact region without replacing preserved nodes.\n\n## Notes / Constraints\n- Multiple regions may exist per element.\n- Keep existing DOMPurify usage for apply stage (handled in ticket C/D).\n\n## Example Cases (must support)\n1) Wikipedia-like infobox cell:\n- DOM contains image wrapper span/a/img, then `\u003cbr\u003e`, then text + links.\n- Extraction should produce region unit(s) for the text+links, and leave image wrapper and `\u003cbr\u003e` out of the unit HTML.\n\n2) Element with multiple text segments separated by preserved nodes:\n- e.g., `TextNode(\"A\")`, icon span (no meaningful text), `TextNode(\"B\")` -\u003e should produce 2 regions.\n\n## Acceptance Criteria\n- Given a container with image-only nodes + a text run, extracted unit(s) include only the text-bearing region HTML and explicitly exclude the image node(s).\n- Region HTML uses existing simplified HTML rules (allowed inline tags/attrs) and does not include `img`.\n- Supports multiple regions within a single unit element and produces deterministic ordering.\n- Does not modify `dist/` or any `*.min.js`.\n","acceptance_criteria":"Given a container with image-only nodes plus a text run, extracted translation unit(s) include only the text-bearing region HTML and explicitly exclude image-only nodes; uses existing simplified HTML rules and does not add img to allowlist.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-26T03:11:41.890105-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-26T03:31:43.596466-05:00","closed_at":"2026-01-26T03:31:43.596466-05:00","close_reason":"Implemented region discovery and unit generation: classifyNode, identifyRegions, serializeRegionNodes, insertRegionMarkers, splitRegionByNodes, collectRegionUnitsFromElement","dependencies":[{"issue_id":"bd-4eo.2","depends_on_id":"bd-4eo","type":"parent-child","created_at":"2026-01-26T03:11:41.891559-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-4eo.2","depends_on_id":"bd-4eo.1","type":"blocks","created_at":"2026-01-26T03:12:23.110921-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-4eo.3","title":"Implement surgical DOM apply for a region","description":"## Context\nFile: `src/extension/content.ts`\n\nCurrent `applyTranslatedHTML()` clears all children of a unit element and inserts translated fragment, which deletes preserved nodes like images/icons that were excluded from simplified HTML.\n\nOption 2: apply translation per-region, replacing only the nodes belonging to that region.\n\n## Task\nAdd/modify helper(s) in `src/extension/content.ts` to surgically apply a translated result for a single region:\n- Compute a `Range` (or equivalent) for the region’s targeted nodes (as specified in ticket A).\n- Sanitize translated HTML with existing DOMPurify configuration.\n- Replace only the region content with a DOM fragment generated from sanitized HTML.\n- Preserve all other siblings within the unit element (e.g., image wrapper `SPAN/A/IMG`, icon nodes, etc.).\n\n## Error Handling\n- If region targeting cannot be resolved (DOM changed / markers missing), skip applying that region and record an error; must not clear the element.\n\n## Acceptance Criteria\n- Applying a translation result for a region does not remove preserved nodes; only the intended region nodes are replaced.\n- Sanitization (DOMPurify) is applied before insertion; no new allowlist expansion (do not add `img`).\n- When region targeting fails, the code leaves the DOM unchanged for that region and reports/records an error.\n- Does not modify `dist/` or any `*.min.js`.\n","acceptance_criteria":"Replacing a translated region updates only the intended region nodes and preserves untouched siblings (e.g., image wrapper span/a/img); translated HTML is sanitized with DOMPurify before insertion.","status":"open","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-26T03:11:54.770487-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-26T03:11:54.770487-05:00","dependencies":[{"issue_id":"bd-4eo.3","depends_on_id":"bd-4eo","type":"parent-child","created_at":"2026-01-26T03:11:54.772421-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-4eo.3","depends_on_id":"bd-4eo.1","type":"blocks","created_at":"2026-01-26T03:12:23.707895-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-4eo.4","title":"Integrate region-based units into translatePageV3 pipeline (chunking + progress)","description":"## Context\nFile: `src/extension/content.ts`\n\nCurrent pipeline translates whole unit element HTML and applies by replacing all children, which deletes preserved nodes.\n\nOption 2 changes granularity: translate and apply per “translatable region” within a unit element.\n\n## Task\nIntegrate region-based translation units into `translatePageV3` end-to-end:\n- Update collection (`collectHTMLTranslationUnits` or equivalent) to emit region-level units (from ticket B) while retaining mapping back to the original unit element and region target metadata.\n- Ensure chunking still works:\n  - Large region HTML must be split to respect `MAX_HTML_UNIT_CHARS`.\n  - Results must be reassembled in correct order for each region.\n- Update apply stage to invoke region-level surgical replacement (ticket C) per region.\n- Support multiple regions per element, applied independently.\n- Maintain/adjust progress indicator logic so it reflects region-level work accurately (including chunk splits).\n- Error handling:\n  - If one region fails translation or apply, record the failure but do not clear or replace preserved content.\n  - Continue applying other regions.\n\n## Acceptance Criteria\n- Region-based units are translated/applied per-region (not whole element).\n- Multiple regions in one element can be translated and applied independently.\n- Large regions still split and reassemble correctly under `MAX_HTML_UNIT_CHARS`.\n- Partial failures mark errors without wiping preserved nodes (e.g., images remain).\n- Progress/error accounting remains accurate (indicator completes, counts match actual work).\n- Does not modify `dist/` or any `*.min.js`.\n","acceptance_criteria":"Region-based units are translated/applied per-region (not whole element); multiple regions per element work; large regions are split/reassembled correctly under MAX_HTML_UNIT_CHARS; partial failures do not wipe images and progress/error accounting remains accurate.","status":"open","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-26T03:12:06.067714-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-26T03:12:06.067714-05:00","dependencies":[{"issue_id":"bd-4eo.4","depends_on_id":"bd-4eo","type":"parent-child","created_at":"2026-01-26T03:12:06.068847-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-4eo.4","depends_on_id":"bd-4eo.1","type":"blocks","created_at":"2026-01-26T03:12:24.498584-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-4eo.5","title":"Manual regression checklist (Wikipedia / links / formatting)","description":"## Context\nThis work changes full-page translation application semantics (region-based replacement) to preserve non-text nodes like images.\n\nBecause there is no automated test suite, we need a clear manual regression checklist.\n\n## Task\nDocument a manual regression checklist to validate the Option 2 fix in both Chrome and Firefox.\n\n## Checklist Requirements\nInclude step-by-step instructions covering:\n- Chrome/Chromium load unpacked flow and Firefox temporary add-on flow (high level, refer to repo README/AGENTS.md patterns).\n- Triggering full-page translation using the existing extension UI.\n- Verifications:\n  1) Wikipedia infobox image + caption\n     - Pick a page with an infobox containing an image.\n     - After translation, the infobox image must remain visible and correctly placed.\n     - Verify that surrounding text is translated and that the `\u003cimg\u003e` node remains in DOM.\n  2) Link-heavy page preserves anchors/hrefs\n     - Example: Wikipedia article body or a news site with many links.\n     - After translation, clicking links works; `href` attributes are preserved; anchor tags remain.\n  3) Formatting-heavy page keeps structure\n     - Tables, lists, code blocks.\n     - After translation, structure and inline styling remain intact.\n  4) No placeholder artifacts or missing HTML\n     - No blank containers where images/icons used to be.\n     - No duplicated/garbled inline elements.\n  5) Extension UI not translated\n     - Ensure translation does not affect extension overlay/indicator/options UI.\n\nAlso include:\n- A short “what to capture in a bug report” section (URL, before/after screenshots, provider settings without API keys, console errors).\n\n## Acceptance Criteria\n- Checklist is complete and can be followed by someone unfamiliar with the change.\n- Checklist covers at least:\n  - Wikipedia infobox image + caption preserved.\n  - Link-heavy page anchors/hrefs preserved.\n  - Formatting-heavy page structure preserved.\n  - No placeholder artifacts/missing HTML.\n  - Extension UI not translated.\n","acceptance_criteria":"Checklist includes step-by-step manual verification in Chrome and Firefox covering: Wikipedia infobox image preserved, link-heavy page anchors/hrefs preserved, formatting-heavy page structure preserved, and no placeholder/missing HTML artifacts; executable by someone unfamiliar with the change.","status":"open","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-26T03:12:17.885156-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-26T03:12:17.885156-05:00","dependencies":[{"issue_id":"bd-4eo.5","depends_on_id":"bd-4eo","type":"parent-child","created_at":"2026-01-26T03:12:17.886797-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-4eo.5","depends_on_id":"bd-4eo.2","type":"blocks","created_at":"2026-01-26T03:12:25.021472-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-4eo.5","depends_on_id":"bd-4eo.3","type":"blocks","created_at":"2026-01-26T03:12:25.677337-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-4eo.5","depends_on_id":"bd-4eo.4","type":"blocks","created_at":"2026-01-26T03:12:26.659844-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-4rx","title":"Migrate options entrypoint to src/extension/options.ts","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:45.157331-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T14:10:17.685319-05:00","closed_at":"2026-01-25T14:10:17.685319-05:00","close_reason":"Migrated options.js to TypeScript with full type safety, using shared storage constants and provider settings","dependencies":[{"issue_id":"bd-4rx","depends_on_id":"bd-g55","type":"blocks","created_at":"2026-01-25T00:41:15.788509-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-4rx","depends_on_id":"bd-nyn","type":"blocks","created_at":"2026-01-25T00:41:15.9452-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-4rx","depends_on_id":"bd-azd","type":"blocks","created_at":"2026-01-25T00:41:16.122011-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-53u","title":"Extract provider defaults/constants into src/shared","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:44.381428-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T04:34:24.099864-05:00","closed_at":"2026-01-25T04:34:24.099864-05:00","close_reason":"Closed","dependencies":[{"issue_id":"bd-53u","depends_on_id":"bd-g6e","type":"blocks","created_at":"2026-01-25T00:41:13.473011-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-53u","depends_on_id":"bd-oc7","type":"blocks","created_at":"2026-01-25T00:41:13.613508-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-5na","title":"Full-page translation async response error","status":"closed","priority":2,"issue_type":"bug","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T02:08:36.265451-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T04:11:55.324734-05:00","closed_at":"2026-01-25T04:11:55.324734-05:00","close_reason":"Implemented missing translateHTMLUnits function in background.js and fixed orphaned catch block in content.js"}
{"id":"bd-76x","title":"Update manifests + build wiring to reference new bundle outputs","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:45.320756-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T14:21:20.747593-05:00","closed_at":"2026-01-25T14:21:20.747593-05:00","close_reason":"Manifests and build wiring already correctly configured. build.ts (bd-g55) bundles from src/extension/ to dist/chrome/ and dist/firefox/ with filenames background.js, content.js, options.js. Source manifests (manifest.json and manifest.firefox.json) already reference these same filenames. Build verified working correctly.","dependencies":[{"issue_id":"bd-76x","depends_on_id":"bd-g55","type":"blocks","created_at":"2026-01-25T00:41:16.269521-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-76x","depends_on_id":"bd-kvu","type":"blocks","created_at":"2026-01-25T00:41:16.409888-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-76x","depends_on_id":"bd-sn0","type":"blocks","created_at":"2026-01-25T00:41:16.554906-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-76x","depends_on_id":"bd-4rx","type":"blocks","created_at":"2026-01-25T00:41:16.709375-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r","title":"Full-page translation overhaul v2","description":"Implement PLAN_v2.md: safe units, placeholder formatting, queue w/ backoff, fallbacks","status":"closed","priority":2,"issue_type":"epic","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:14.49524-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:04:23.541698-05:00","closed_at":"2026-01-24T23:04:23.541698-05:00","close_reason":"All 8 child tasks completed: safe unit collection, size splitting, placeholder serialization/validation, background translateUnit handler, TranslationQueue with concurrency/retry/cache, apply-to-DOM logic, UX progress states, and fallbacks. Build verified for Chrome/Firefox."}
{"id":"bd-77r.1","title":"Content: collect safe translation units","description":"Implement leaf-ish block unit selection + traversal filters; skip hidden/interactive; exclude extension UI","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:14.630611-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T22:55:00.856559-05:00","closed_at":"2026-01-24T22:55:00.856559-05:00","close_reason":"Implemented collectSafeTranslationUnits with SKIP_TAGS, INTERACTIVE_TAGS, BLOCK_LEVEL_TAGS, INLINE_SAFE_TAGS, EXTENSION_UI_SELECTORS constants and helper functions: isHiddenElement, isExtensionUI, containsInteractiveControls, containsNestedBlocks, isSafeTranslationUnit","dependencies":[{"issue_id":"bd-77r.1","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:14.631561-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.2","title":"Content: unit size caps + splitting","description":"Add MAX_UNIT_CHARS/HARD_MAX_UNIT_CHARS; split oversized units by sentences/paragraphs with safe fallback","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:14.771796-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T22:56:34.851692-05:00","closed_at":"2026-01-24T22:56:34.851692-05:00","close_reason":"Added MAX_UNIT_CHARS (800) and HARD_MAX_UNIT_CHARS (2000) constants; implemented splitIntoSentences, splitTextIntoChunks, splitByWords, unitNeedsSplitting helper functions; updated collectSafeTranslationUnits to split oversized units with chunkIndex/totalChunks metadata","dependencies":[{"issue_id":"bd-77r.2","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:14.772716-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.2","depends_on_id":"bd-77r.1","type":"blocks","created_at":"2026-01-24T22:51:15.694735-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.3","title":"Content: placeholder serialization + validation","description":"Serialize units into placeholder-marked text; validate placeholder integrity in output; retry once with stricter prompt","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:14.908126-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T22:57:36.284662-05:00","closed_at":"2026-01-24T22:57:36.284662-05:00","close_reason":"Implemented placeholder serialization system: serializeUnitWithPlaceholders (walks DOM, emits paired markers like ⟦P0⟧/⟦/P0⟧), extractPlaceholderTokens, validatePlaceholders (checks input vs output), parsePlaceholderOutput (parses into segments), isOutputTruncated (detects truncation)","dependencies":[{"issue_id":"bd-77r.3","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:14.909844-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.3","depends_on_id":"bd-77r.2","type":"blocks","created_at":"2026-01-24T22:51:15.796829-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.4","title":"Background: translateUnit handler + prompts","description":"Add action=translateUnit handler; placeholder-safe system prompt; return text only (no markdown); set sane token cap","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:15.047542-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T22:59:28.292573-05:00","closed_at":"2026-01-24T22:59:28.292573-05:00","close_reason":"Added PLACEHOLDER_SAFE_SYSTEM_PROMPT, PLACEHOLDER_STRICT_SYSTEM_PROMPT, MAX_UNIT_TOKENS (1024) constants; added translateUnit message handler; implemented translateUnitText async function with placeholder-safe prompting and retry support with stricter prompt","dependencies":[{"issue_id":"bd-77r.4","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:15.048476-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.4","depends_on_id":"bd-77r.3","type":"blocks","created_at":"2026-01-24T22:51:15.899112-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.5","title":"Content: TranslationQueue (concurrency, retry/backoff, cache)","description":"Concurrency=3; per-unit timeout; retry 429/503/network w/ exponential backoff; cache key includes provider/model/instructions + serialized input","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:15.183961-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:00:41.533635-05:00","closed_at":"2026-01-24T23:00:41.533635-05:00","close_reason":"Implemented TranslationQueue class with: QUEUE_CONCURRENCY=3, QUEUE_TIMEOUT_MS=15000, QUEUE_MAX_RETRIES=3, QUEUE_BASE_BACKOFF_MS=1000; exponential backoff with jitter for 429/503/network errors; in-memory cache keyed by serialized input; progress callbacks; stop() method for cancellation","dependencies":[{"issue_id":"bd-77r.5","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:15.184883-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.5","depends_on_id":"bd-77r.4","type":"blocks","created_at":"2026-01-24T22:51:16.001113-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.6","title":"Content: apply translation via text node updates","description":"Parse placeholder output and update existing text nodes while preserving inline DOM nodes (avoid innerHTML writes)","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:15.319603-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:01:56.710743-05:00","closed_at":"2026-01-24T23:01:56.710743-05:00","close_reason":"Implemented applyTranslationToUnit() which parses placeholder output and updates text nodes proportionally while preserving DOM structure; added applyPlainTextFallback() for simple cases; distributes translated text across multiple text nodes based on original length proportions","dependencies":[{"issue_id":"bd-77r.6","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:15.320539-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.6","depends_on_id":"bd-77r.5","type":"blocks","created_at":"2026-01-24T22:51:16.104673-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.7","title":"UX: progress states + stop + error policy","description":"Preparing/translating/done/stopped states; stop cancels remaining work; summarize errors without console spam","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:15.457155-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:03:37.350434-05:00","closed_at":"2026-01-24T23:03:37.350434-05:00","close_reason":"Implemented translatePageV2() with TranslationQueue; displayLoadingIndicatorV2 with state-aware styling (preparing/translating/done/stopped/error); stopTranslationV2() wired to queue.stop(); progress callback updates; unit completion applies translation or marks errors; wired to startElementTranslation message handler","dependencies":[{"issue_id":"bd-77r.7","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:15.45803-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.7","depends_on_id":"bd-77r.6","type":"blocks","created_at":"2026-01-24T22:51:16.208141-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.8","title":"Fallback modes + cleanup + smoke tests","description":"Add text-only fallback; optional HTML fallback w/ strict DOMPurify safe-URI; remove old full-page HTML flow; run manual smoke checks","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:15.592561-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:04:08.066867-05:00","closed_at":"2026-01-24T23:04:08.066867-05:00","close_reason":"Text-only fallback via applyPlainTextFallback already implemented; fallback used when applyTranslationToUnit returns false; old translatePageElements kept but deprecated (v2 is now default); build succeeds for both Chrome and Firefox","dependencies":[{"issue_id":"bd-77r.8","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:15.593443-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.8","depends_on_id":"bd-77r.7","type":"blocks","created_at":"2026-01-24T22:51:16.309933-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-7ep","title":"Content: sanitize + apply translated HTML per unit (preserve href)","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T01:02:35.780632-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T01:25:19.760621-05:00","closed_at":"2026-01-25T01:25:19.760621-05:00","close_reason":"Implemented sanitizeTranslatedHTML(), applyTranslatedHTML(), and translatePageV3() for HTML-preserving translation with href preservation","dependencies":[{"issue_id":"bd-7ep","depends_on_id":"bd-8rr","type":"blocks","created_at":"2026-01-25T01:02:47.792156-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-7ep","depends_on_id":"bd-bqj","type":"blocks","created_at":"2026-01-25T01:02:48.466718-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-8rr","title":"Full-page: DOM unit selection + HTML extraction","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T01:02:34.147784-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T01:11:29.0757-05:00","closed_at":"2026-01-25T01:11:29.0757-05:00","close_reason":"Implemented collectHTMLTranslationUnits() and extractUnitHTML() functions"}
{"id":"bd-azd","title":"Type chrome.storage schema + helpers in src/shared","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:44.710939-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T13:44:00.757381-05:00","closed_at":"2026-01-25T13:44:00.757381-05:00","close_reason":"Closed","dependencies":[{"issue_id":"bd-azd","depends_on_id":"bd-g6e","type":"blocks","created_at":"2026-01-25T00:41:14.316995-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-azd","depends_on_id":"bd-oc7","type":"blocks","created_at":"2026-01-25T00:41:14.472082-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-azd","depends_on_id":"bd-53u","type":"blocks","created_at":"2026-01-25T00:41:14.614822-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-azg","title":"Verification: manual smoke checklist (Chrome + Firefox)","notes":"Automated verification complete. All build files present, context menus registered, storage sync configured, DOMPurify integrated. Created VERIFICATION.md with comprehensive test checklist. Manual browser testing required to complete verification (6 tests: translate selected text, translate entire page, settings persistence, link preservation, formatting preservation, no artifacts).","status":"closed","priority":3,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:45.802781-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T14:28:38.172893-05:00","closed_at":"2026-01-25T14:28:38.172893-05:00","close_reason":"Automated verification complete. Build verification passed (Chrome + Firefox), code structure verified (context menus, storage sync, DOMPurify integration). Created VERIFICATION.md with 6 manual test steps requiring browser testing. All automated checks passed.","dependencies":[{"issue_id":"bd-azg","depends_on_id":"bd-rxn","type":"blocks","created_at":"2026-01-25T00:41:17.748527-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-bqj","title":"Background: translate HTML units with HTML-preserving prompt + token budgeting","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T01:02:34.95559-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T01:18:04.871036-05:00","closed_at":"2026-01-25T01:18:04.871036-05:00","close_reason":"Implemented translateHTMLUnits with HTML-preserving prompts and token budgeting for batch translation","dependencies":[{"issue_id":"bd-bqj","depends_on_id":"bd-8rr","type":"blocks","created_at":"2026-01-25T01:02:47.105245-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-bte","title":"Docs: update README/build instructions for TS layout","status":"closed","priority":3,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:45.623002-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T14:26:43.450489-05:00","closed_at":"2026-01-25T14:26:43.450489-05:00","close_reason":"Closed","dependencies":[{"issue_id":"bd-bte","depends_on_id":"bd-rxn","type":"blocks","created_at":"2026-01-25T00:41:17.594071-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-di4","title":"Remove placeholder-based full-page v2 pipeline and prompts","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T01:02:37.420237-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T01:49:36.334816-05:00","closed_at":"2026-01-25T01:49:36.334816-05:00","close_reason":"Remove placeholder-based full-page v2 pipeline","dependencies":[{"issue_id":"bd-di4","depends_on_id":"bd-7ep","type":"blocks","created_at":"2026-01-25T01:02:50.552687-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-di4","depends_on_id":"bd-2xd","type":"blocks","created_at":"2026-01-25T01:02:51.1721-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-dpe","title":"Refactor to TypeScript repo","status":"closed","priority":2,"issue_type":"feature","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:25.073005-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T14:45:29.696097-05:00","closed_at":"2026-01-25T14:45:29.696097-05:00","close_reason":"All dependencies completed. Successfully refactored to TypeScript with src/ layout, typed messaging protocol, shared constants, typed storage schema, bundled entrypoints, moved static assets, updated manifests, and verification complete.","dependencies":[{"issue_id":"bd-dpe","depends_on_id":"bd-g6e","type":"blocks","created_at":"2026-01-25T00:41:10.517792-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-oc7","type":"blocks","created_at":"2026-01-25T00:41:10.667079-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-g55","type":"blocks","created_at":"2026-01-25T00:41:10.811344-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-53u","type":"blocks","created_at":"2026-01-25T00:41:10.953882-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-nyn","type":"blocks","created_at":"2026-01-25T00:41:11.095529-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-azd","type":"blocks","created_at":"2026-01-25T00:41:11.305121-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-kvu","type":"blocks","created_at":"2026-01-25T00:41:11.448052-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-sn0","type":"blocks","created_at":"2026-01-25T00:41:11.618513-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-4rx","type":"blocks","created_at":"2026-01-25T00:41:11.767712-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-76x","type":"blocks","created_at":"2026-01-25T00:41:11.925635-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-rxn","type":"blocks","created_at":"2026-01-25T00:41:12.072684-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-bte","type":"blocks","created_at":"2026-01-25T00:41:12.219682-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-azg","type":"blocks","created_at":"2026-01-25T00:41:12.368619-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-mdz","type":"blocks","created_at":"2026-01-25T00:41:12.745426-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-dpe","depends_on_id":"bd-rwz","type":"blocks","created_at":"2026-01-25T00:41:12.899243-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-fz1","title":"Full-page translation: HTML-preserving pipeline (no placeholders)","status":"closed","priority":2,"issue_type":"feature","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T01:02:31.402145-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T01:59:32.190123-05:00","closed_at":"2026-01-25T01:59:32.190123-05:00","close_reason":"Closed","dependencies":[{"issue_id":"bd-fz1","depends_on_id":"bd-8rr","type":"blocks","created_at":"2026-01-25T01:02:43.209915-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-fz1","depends_on_id":"bd-bqj","type":"blocks","created_at":"2026-01-25T01:02:43.818909-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-fz1","depends_on_id":"bd-7ep","type":"blocks","created_at":"2026-01-25T01:02:44.476607-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-fz1","depends_on_id":"bd-2xd","type":"blocks","created_at":"2026-01-25T01:02:45.138267-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-fz1","depends_on_id":"bd-di4","type":"blocks","created_at":"2026-01-25T01:02:45.756738-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-fz1","depends_on_id":"bd-4al","type":"blocks","created_at":"2026-01-25T01:02:46.429475-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-g55","title":"Update build.ts to bundle TS entrypoints from src/extension","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:44.188383-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T04:30:39.916727-05:00","closed_at":"2026-01-25T04:30:39.916727-05:00","close_reason":"Updated build.ts to bundle TS entrypoints from src/extension (changed entrypoints from .js to .ts and updated source path)","dependencies":[{"issue_id":"bd-g55","depends_on_id":"bd-g6e","type":"blocks","created_at":"2026-01-25T00:41:13.191476-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-g55","depends_on_id":"bd-oc7","type":"blocks","created_at":"2026-01-25T00:41:13.331624-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-g6e","title":"Add src/ layout and TypeScript config scaffolding","description":"Created src/ directory layout with src/extension/ and src/shared/ subdirectories. Added tsconfig.json with appropriate compiler options for browser extension development. Each directory includes a README documenting its purpose.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:43.824242-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T04:23:16.94815-05:00","closed_at":"2026-01-25T04:23:16.94815-05:00","close_reason":"Completed: created src/extension/ and src/shared/ directory structure with READMEs, added tsconfig.json with appropriate browser extension TypeScript configuration"}
{"id":"bd-kvu","title":"Migrate background entrypoint to src/extension/background.ts","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:44.857737-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T13:51:21.065022-05:00","closed_at":"2026-01-25T13:51:21.065022-05:00","close_reason":"Migrated background.js to TypeScript at src/extension/background.ts. All constants, types, and storage helpers are now imported from shared modules.","dependencies":[{"issue_id":"bd-kvu","depends_on_id":"bd-g55","type":"blocks","created_at":"2026-01-25T00:41:14.791215-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-kvu","depends_on_id":"bd-nyn","type":"blocks","created_at":"2026-01-25T00:41:14.960497-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-kvu","depends_on_id":"bd-azd","type":"blocks","created_at":"2026-01-25T00:41:15.113252-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-mdz","title":"Optional: refactor build.ts to dedupe chrome/firefox build steps","status":"closed","priority":4,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:45.976711-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T14:31:20.417377-05:00","closed_at":"2026-01-25T14:31:20.417377-05:00","close_reason":"Closed","dependencies":[{"issue_id":"bd-mdz","depends_on_id":"bd-g55","type":"blocks","created_at":"2026-01-25T00:41:17.897545-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-nyn","title":"Define typed message protocol for runtime messaging","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:44.547575-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T13:40:14.213473-05:00","closed_at":"2026-01-25T13:40:14.213473-05:00","close_reason":"Created typed message protocol for runtime messaging in src/shared/messaging.ts with all message types, responses, and port messages defined","dependencies":[{"issue_id":"bd-nyn","depends_on_id":"bd-g6e","type":"blocks","created_at":"2026-01-25T00:41:13.763919-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-nyn","depends_on_id":"bd-oc7","type":"blocks","created_at":"2026-01-25T00:41:14.01786-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-nyn","depends_on_id":"bd-53u","type":"blocks","created_at":"2026-01-25T00:41:14.170219-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-oc7","title":"Add TypeScript type deps and strictness baseline","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:43.980495-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T04:29:33.233695-05:00","closed_at":"2026-01-25T04:29:33.233695-05:00","close_reason":"Added @types/chrome dev dependency. tsconfig.json already has strict: true and appropriate strictness settings.","dependencies":[{"issue_id":"bd-oc7","depends_on_id":"bd-g6e","type":"blocks","created_at":"2026-01-25T00:41:13.052871-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-rwz","title":"Optional: move static assets into assets/ (no dist edits)","status":"closed","priority":4,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:46.16137-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T14:44:57.128709-05:00","closed_at":"2026-01-25T14:44:57.128709-05:00","close_reason":"Successfully moved all static assets into assets/ directory. Updated build.ts to strip 'assets/' prefix when copying to dist/. Build tested and working correctly.","dependencies":[{"issue_id":"bd-rwz","depends_on_id":"bd-g55","type":"blocks","created_at":"2026-01-25T00:41:18.084031-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-rwz","depends_on_id":"bd-76x","type":"blocks","created_at":"2026-01-25T00:41:18.24401-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-rxn","title":"Remove legacy root JS entrypoints after TS migration","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:45.471859-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T14:23:59.868656-05:00","closed_at":"2026-01-25T14:23:59.868656-05:00","close_reason":"Removed legacy root JS files (background.js, content.js, options.js) after successful TypeScript migration. Build process now bundles from src/extension/*.ts and outputs to dist/ directories.","dependencies":[{"issue_id":"bd-rxn","depends_on_id":"bd-76x","type":"blocks","created_at":"2026-01-25T00:41:16.865188-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-rxn","depends_on_id":"bd-kvu","type":"blocks","created_at":"2026-01-25T00:41:17.108245-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-rxn","depends_on_id":"bd-sn0","type":"blocks","created_at":"2026-01-25T00:41:17.29614-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-rxn","depends_on_id":"bd-4rx","type":"blocks","created_at":"2026-01-25T00:41:17.448865-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-sn0","title":"Migrate content entrypoint to src/extension/content.ts","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-25T00:40:45.005166-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T14:05:21.59598-05:00","closed_at":"2026-01-25T14:05:21.59598-05:00","close_reason":"Migrated content.js to TypeScript at src/extension/content.ts","dependencies":[{"issue_id":"bd-sn0","depends_on_id":"bd-g55","type":"blocks","created_at":"2026-01-25T00:41:15.301651-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-sn0","depends_on_id":"bd-nyn","type":"blocks","created_at":"2026-01-25T00:41:15.45623-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-sn0","depends_on_id":"bd-azd","type":"blocks","created_at":"2026-01-25T00:41:15.608114-05:00","created_by":"Adin Schmidt"}]}
