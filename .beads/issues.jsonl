{"id":"bd-2m3","title":"Full-page translation v2 gaps","description":"Follow-up work to fully cover PLAN_v2 requirements on master. Each child task is self-contained with all needed context, because plan docs may be removed.","status":"open","priority":2,"issue_type":"epic","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:22:38.187178-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:22:38.187178-05:00"}
{"id":"bd-2m3.1","title":"Enforce HARD_MAX_UNIT_CHARS during splitting","description":"Context: `content.js` defines `MAX_UNIT_CHARS=800` and `HARD_MAX_UNIT_CHARS=2000`, but splitting functions only use MAX; long sentences/words can exceed the hard cap and still be sent to the API. Work: - Update `splitTextIntoChunks`, `splitByWords`, and `unitNeedsSplitting` to enforce `HARD_MAX_UNIT_CHARS` so no chunk exceeds 2000 chars. - When a sentence or word exceeds `HARD_MAX_UNIT_CHARS`, split by character slices (preserve order). - Ensure `collectSafeTranslationUnits` uses the updated splitter and keeps `chunkIndex`/`totalChunks` accurate. Acceptance: - No serialized unit/chunk exceeds `HARD_MAX_UNIT_CHARS`. - Oversized single words/sentences are split deterministically. - Chunk metadata remains correct and translation flow unchanged otherwise.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:22:54.469463-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:32:57.30549-05:00","closed_at":"2026-01-24T23:32:57.30549-05:00","close_reason":"Added splitByCharacters helper and updated splitByWords to enforce HARD_MAX_UNIT_CHARS (2000) by splitting oversized words by character slices","dependencies":[{"issue_id":"bd-2m3.1","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:22:54.471376-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.2","title":"Cache key includes provider/model/language/instructions + placeholders","description":"Context: `TranslationQueue.getCacheKey` currently returns only `serializedText` (plain text), so cache collisions occur across providers, models, languages, and formatting; placeholder tokens are not included in the key. Work: - Build a stable cache context at translation start (provider, model, endpoint, target language, translation instructions). - Include the placeholder-serialized input string (with ⟦P0⟧/⟦/P0⟧) in the key. - Update `TranslationQueue.getCacheKey` to incorporate the context + placeholder string (hashing is OK). Acceptance: - Cache keys differ across provider/model/endpoint/language/instructions. - Cache uses placeholder-serialized input, not just `.textContent`.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:22:57.653022-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:39:51.126112-05:00","closed_at":"2026-01-24T23:39:51.126112-05:00","close_reason":"Closed","dependencies":[{"issue_id":"bd-2m3.2","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:22:57.654378-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.3","title":"Use placeholder validation + truncation detection to trigger fallback","description":"Context: `validatePlaceholders` is checked but invalid output is still used after retries; `isOutputTruncated` exists but is never invoked. Work: - After each translation result, run `validatePlaceholders` and `isOutputTruncated`. - If invalid/truncated, retry once using the strict placeholder prompt. - If still invalid/truncated, treat the unit as failed and trigger fallback (text-only or HTML fallback) instead of applying the bad output. - Ensure queue stats reflect failures and `onUnitComplete` receives `success:false` for fallback paths. Acceptance: - Invalid or truncated outputs are never applied to the DOM. - Retry happens once with strict prompt, then fallback is used.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:23:00.914262-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:43:49.525121-05:00","closed_at":"2026-01-24T23:43:49.525121-05:00","close_reason":"Closed","dependencies":[{"issue_id":"bd-2m3.3","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:23:00.916948-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.4","title":"Include translation instructions in translateUnit prompt","description":"Context: `background.js` `translateUnitText` only uses a generic \"Translate to {language}\" prompt and ignores user/provider `translationInstructions`. Work: - Resolve `translationInstructions` similarly to `getSettingsAndTranslate`: - Basic mode: `buildBasicTranslationInstructions(languageLabel)` - Advanced mode: `perProvider.translationInstructions` or `DEFAULT_TRANSLATION_INSTRUCTIONS` - Prepend these instructions to the user prompt, along with the placeholder-preservation requirement. - Ensure the instructions are part of the cache key context (see cache-key task). Acceptance: - Unit translations respect custom instructions in Advanced mode and Basic mode defaults.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:23:03.647713-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:48:25.004948-05:00","closed_at":"2026-01-24T23:48:25.004948-05:00","close_reason":"Implemented: translateUnitText now resolves translationInstructions from settings (Basic mode: buildBasicTranslationInstructions; Advanced mode: perProvider.translationInstructions or DEFAULT_TRANSLATION_INSTRUCTIONS) and includes them in the user prompt along with placeholder-preservation requirement.","dependencies":[{"issue_id":"bd-2m3.4","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:23:03.649636-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.5","title":"Placeholder-aware applyTranslationToUnit mapping","description":"Context: `applyTranslationToUnit` parses placeholders but then concatenates all text and distributes by proportion, which can misassign text to inline elements. Work: - Use `parsePlaceholderOutput` to map translated segments between ⟦P#⟧ markers to the correct text nodes. - Walk the DOM and apply text to the exact nodes inside matching inline elements; keep DOM structure intact and avoid `innerHTML` writes. - If placeholder mapping fails, return false to trigger fallback. Acceptance: - Inline formatting boundaries are preserved; text does not drift across inline elements. - Placeholder tokens drive segmentation, not proportional heuristics.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:23:06.547164-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T00:08:25.816051-05:00","closed_at":"2026-01-25T00:08:25.816051-05:00","close_reason":"Implemented placeholder-aware applyTranslationToUnit mapping","dependencies":[{"issue_id":"bd-2m3.5","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:23:06.548854-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.6","title":"HTML fallback with DOMPurify + safe URI policy","description":"Context: Only text-only fallback exists; PLAN_v2 specifies an optional HTML fallback for inline-only safe elements with strict sanitization. Work: - Implement optional HTML fallback when placeholder mapping fails. - Only run on elements that are inline-only and have no interactive descendants. - Translate inline HTML (reuse `translateElement` or add a dedicated handler). - Sanitize with DOMPurify using an explicit allowlist and enforce safe URI protocols (http/https/mailto/relative; reject javascript:, data:, etc.). Acceptance: - HTML fallback only runs on safe inline-only elements. - Sanitized output contains only allowed tags/attrs and safe hrefs.","status":"in_progress","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:23:09.406582-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-25T00:12:45.21085-05:00","dependencies":[{"issue_id":"bd-2m3.6","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:23:09.408432-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.7","title":"Error policy threshold + reduced per-unit logging","description":"Context: Per-unit errors are logged individually; there is no thresholded summary when error rates are high. Work: - Track error count and error rate in `translatePageV2` or the queue callbacks. - Log only the first N errors (e.g., 3), then suppress per-unit logs. - If error rate \u003e 20%, show a summary message in the UI and/or a single console warning. Acceptance: - Console spam is reduced; summary appears when error rate is high.","status":"open","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:23:12.224146-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:23:12.224146-05:00","dependencies":[{"issue_id":"bd-2m3.7","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:23:12.226082-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-2m3.8","title":"Stop ignores late results","description":"Context: `TranslationQueue.stop()` prevents new work but in-flight translations still apply via `onUnitComplete`; PLAN_v2 expects late results to be ignored. Work: - When stop is triggered, ignore any late `onUnitComplete` results (check `queue.stopped` / `stopTranslationFlag` before applying). - Ensure no additional DOM updates occur after Stop is pressed. Acceptance: - After stop, no new elements are translated or updated, even if in-flight requests complete.","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T23:23:14.419453-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:46:05.992327-05:00","closed_at":"2026-01-24T23:46:05.992327-05:00","close_reason":"Added stopTranslationFlag check at start of onUnitComplete callback to ignore late results after stop is triggered","dependencies":[{"issue_id":"bd-2m3.8","depends_on_id":"bd-2m3","type":"parent-child","created_at":"2026-01-24T23:23:14.421608-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r","title":"Full-page translation overhaul v2","description":"Implement PLAN_v2.md: safe units, placeholder formatting, queue w/ backoff, fallbacks","status":"closed","priority":2,"issue_type":"epic","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:14.49524-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:04:23.541698-05:00","closed_at":"2026-01-24T23:04:23.541698-05:00","close_reason":"All 8 child tasks completed: safe unit collection, size splitting, placeholder serialization/validation, background translateUnit handler, TranslationQueue with concurrency/retry/cache, apply-to-DOM logic, UX progress states, and fallbacks. Build verified for Chrome/Firefox."}
{"id":"bd-77r.1","title":"Content: collect safe translation units","description":"Implement leaf-ish block unit selection + traversal filters; skip hidden/interactive; exclude extension UI","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:14.630611-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T22:55:00.856559-05:00","closed_at":"2026-01-24T22:55:00.856559-05:00","close_reason":"Implemented collectSafeTranslationUnits with SKIP_TAGS, INTERACTIVE_TAGS, BLOCK_LEVEL_TAGS, INLINE_SAFE_TAGS, EXTENSION_UI_SELECTORS constants and helper functions: isHiddenElement, isExtensionUI, containsInteractiveControls, containsNestedBlocks, isSafeTranslationUnit","dependencies":[{"issue_id":"bd-77r.1","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:14.631561-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.2","title":"Content: unit size caps + splitting","description":"Add MAX_UNIT_CHARS/HARD_MAX_UNIT_CHARS; split oversized units by sentences/paragraphs with safe fallback","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:14.771796-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T22:56:34.851692-05:00","closed_at":"2026-01-24T22:56:34.851692-05:00","close_reason":"Added MAX_UNIT_CHARS (800) and HARD_MAX_UNIT_CHARS (2000) constants; implemented splitIntoSentences, splitTextIntoChunks, splitByWords, unitNeedsSplitting helper functions; updated collectSafeTranslationUnits to split oversized units with chunkIndex/totalChunks metadata","dependencies":[{"issue_id":"bd-77r.2","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:14.772716-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.2","depends_on_id":"bd-77r.1","type":"blocks","created_at":"2026-01-24T22:51:15.694735-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.3","title":"Content: placeholder serialization + validation","description":"Serialize units into placeholder-marked text; validate placeholder integrity in output; retry once with stricter prompt","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:14.908126-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T22:57:36.284662-05:00","closed_at":"2026-01-24T22:57:36.284662-05:00","close_reason":"Implemented placeholder serialization system: serializeUnitWithPlaceholders (walks DOM, emits paired markers like ⟦P0⟧/⟦/P0⟧), extractPlaceholderTokens, validatePlaceholders (checks input vs output), parsePlaceholderOutput (parses into segments), isOutputTruncated (detects truncation)","dependencies":[{"issue_id":"bd-77r.3","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:14.909844-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.3","depends_on_id":"bd-77r.2","type":"blocks","created_at":"2026-01-24T22:51:15.796829-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.4","title":"Background: translateUnit handler + prompts","description":"Add action=translateUnit handler; placeholder-safe system prompt; return text only (no markdown); set sane token cap","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:15.047542-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T22:59:28.292573-05:00","closed_at":"2026-01-24T22:59:28.292573-05:00","close_reason":"Added PLACEHOLDER_SAFE_SYSTEM_PROMPT, PLACEHOLDER_STRICT_SYSTEM_PROMPT, MAX_UNIT_TOKENS (1024) constants; added translateUnit message handler; implemented translateUnitText async function with placeholder-safe prompting and retry support with stricter prompt","dependencies":[{"issue_id":"bd-77r.4","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:15.048476-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.4","depends_on_id":"bd-77r.3","type":"blocks","created_at":"2026-01-24T22:51:15.899112-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.5","title":"Content: TranslationQueue (concurrency, retry/backoff, cache)","description":"Concurrency=3; per-unit timeout; retry 429/503/network w/ exponential backoff; cache key includes provider/model/instructions + serialized input","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:15.183961-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:00:41.533635-05:00","closed_at":"2026-01-24T23:00:41.533635-05:00","close_reason":"Implemented TranslationQueue class with: QUEUE_CONCURRENCY=3, QUEUE_TIMEOUT_MS=15000, QUEUE_MAX_RETRIES=3, QUEUE_BASE_BACKOFF_MS=1000; exponential backoff with jitter for 429/503/network errors; in-memory cache keyed by serialized input; progress callbacks; stop() method for cancellation","dependencies":[{"issue_id":"bd-77r.5","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:15.184883-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.5","depends_on_id":"bd-77r.4","type":"blocks","created_at":"2026-01-24T22:51:16.001113-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.6","title":"Content: apply translation via text node updates","description":"Parse placeholder output and update existing text nodes while preserving inline DOM nodes (avoid innerHTML writes)","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:15.319603-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:01:56.710743-05:00","closed_at":"2026-01-24T23:01:56.710743-05:00","close_reason":"Implemented applyTranslationToUnit() which parses placeholder output and updates text nodes proportionally while preserving DOM structure; added applyPlainTextFallback() for simple cases; distributes translated text across multiple text nodes based on original length proportions","dependencies":[{"issue_id":"bd-77r.6","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:15.320539-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.6","depends_on_id":"bd-77r.5","type":"blocks","created_at":"2026-01-24T22:51:16.104673-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.7","title":"UX: progress states + stop + error policy","description":"Preparing/translating/done/stopped states; stop cancels remaining work; summarize errors without console spam","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:15.457155-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:03:37.350434-05:00","closed_at":"2026-01-24T23:03:37.350434-05:00","close_reason":"Implemented translatePageV2() with TranslationQueue; displayLoadingIndicatorV2 with state-aware styling (preparing/translating/done/stopped/error); stopTranslationV2() wired to queue.stop(); progress callback updates; unit completion applies translation or marks errors; wired to startElementTranslation message handler","dependencies":[{"issue_id":"bd-77r.7","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:15.45803-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.7","depends_on_id":"bd-77r.6","type":"blocks","created_at":"2026-01-24T22:51:16.208141-05:00","created_by":"Adin Schmidt"}]}
{"id":"bd-77r.8","title":"Fallback modes + cleanup + smoke tests","description":"Add text-only fallback; optional HTML fallback w/ strict DOMPurify safe-URI; remove old full-page HTML flow; run manual smoke checks","status":"closed","priority":2,"issue_type":"task","owner":"9936213+adinschmidt@users.noreply.github.com","created_at":"2026-01-24T22:51:15.592561-05:00","created_by":"Adin Schmidt","updated_at":"2026-01-24T23:04:08.066867-05:00","closed_at":"2026-01-24T23:04:08.066867-05:00","close_reason":"Text-only fallback via applyPlainTextFallback already implemented; fallback used when applyTranslationToUnit returns false; old translatePageElements kept but deprecated (v2 is now default); build succeeds for both Chrome and Firefox","dependencies":[{"issue_id":"bd-77r.8","depends_on_id":"bd-77r","type":"parent-child","created_at":"2026-01-24T22:51:15.593443-05:00","created_by":"Adin Schmidt"},{"issue_id":"bd-77r.8","depends_on_id":"bd-77r.7","type":"blocks","created_at":"2026-01-24T22:51:16.309933-05:00","created_by":"Adin Schmidt"}]}
